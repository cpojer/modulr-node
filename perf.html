<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
<title>modulr.perf</title>
<script src="./javascripts/d3.v2.js" type="text/javascript" charset="utf-8"></script>
<script src="./javascripts/d3.tip.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css" media="screen">
   .chart g.selected rect.bckgrnd {
     fill: #fff;
   }
   
   .chart rect.bckgrnd {
     fill: #eee;
     opacity: 0.5;
   }

   .chart rect.total {
     fill: #FFDFB8;
   }

   .chart rect.actual {
     fill: #FE9D36;
   }
   
   .chart g.selected rect.total {
     fill: #FFC580;
   }

   .chart g.selected rect.actual {
     fill: #FF8310;
   }

   .rule {
     color: #eee;
   }
   
   .chart {
     font-size: 10px;
     padding: 15px;
     color: #666;
   }
   .d3-tip {
     fill: #666;
     margin: 10px;
   }

   .d3-tip text {
     fill: #fff;
     font-size: 11px;
     stroke: none;
   }
   
   #input_zone {
     margin: 15px;
     width: 1080px;
     
   }
   
   body {
     font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
     padding: 15px;
   }
	</style>
</head>
<body>
  <div id="container">
    
  </div>
  <p>Insert a stringified <code>modulr.perf</code> object here and chart away!</p>
  <p><textarea id="input_zone" rows="8" placeholder="JSON goes here"></textarea></p>
  <p><input type=button value="Chart!" onclick="chart(document.getElementById('input_zone').value); return false"> <span id="error_msg" style="color: red; display: none">Oops, I failed to parse the JSON data you provided. Can you please make sure it's well formatted?</span></p>
<script type="text/javascript" charset="utf-8">

var current;
function chart(originalData) {
  document.getElementById('error_msg').style.display = 'none';
  
  function prepareData(input) {
    var modules = {};

    Object.keys(input.modules).forEach(function(id) {
      var m = input.modules[id];
      m.id = id;
      modules[m.left] = m;
    });

    return modules;
  }

  function getRoots(obj) {
    var node = obj[1], output = [];
    while(node) {
      output.push(node);
      node = obj[node.right + 1];
    }
    return output;
  }

  function isLeaf(node) {
    return node.left + 1 === node.right;
  }

  function getChildren(root, context) {
    var i = root.left + 1,
        output = [];
    while (i < root.right) {
      if (context[i]) {
        output.push(context[i])
      }
      i++;
    }
    return output;
  }
  try {
    originalData = JSON.parse(originalData);
  } catch(e) {
    document.getElementById('error_msg').style.display = '';
    return;
  }
  
  if (!originalData) {
    document.getElementById('error_msg').style.display = '';
    return;
  }
  
  if (!originalData.modules) {
    originalData = originalData.perf;
  }
  
  var modules = prepareData(originalData);
  
  var t0;
  var ouput = []

  getRoots(modules).forEach(function(root) {

    var arr = getChildren(root, modules);
    if (!t0) { t0 = root.start };
    arr.unshift(root);

    function iterate(arr) {
      var root = arr.shift();
      var times = [];
      times.node = root;
      if (isLeaf(root)) {
        times.push([root.start - t0, root.end - t0])
        return times;
      }

      var max = root.start - t0;
      arr.forEach(function(n) {
        if (n.left > root.right) { 
          return; // not a child
        }
        var start = n.start - t0; 
        if (start >= max) {
          times.push([max, start]);
          max = n.end - t0;
        }
      });
      times.push([max, root.end - t0])
      return times;
    }

    var a = arr.slice(0);
    while (a.length) {
      ouput.push(iterate(a))
    }
  });

  data = ouput;

  var HEIGHT = 10,
      INNER_HEIGHT = HEIGHT - 1,
      MAX_WIDTH = 1080;

  function min(d) {
    return d[0][0];
  }

  function max(d) {
    return d[d.length-1][1];
  }

  function delta(d) {
    return max(d) - min(d);
  }

  function addTime(d) {
    return d.reduce(function(sum, tuple) {
      return sum + tuple[1] - tuple[0]
    }, 0);
  }

  function formatTime(d) {
    if (d === 0) {
      return "0"
    }
    if (d > 1000) {
      return (Math.round(d / 100) / 10) + 's';
    }
    return d + 'ms';
  }

  var max_time = d3.max(data.map(function(row) {
    return row[row.length - 1][1];
  }));
  
  if (current) { current.remove() }
  
  var chart = d3.select("#container").append("svg")
      .attr("class", "chart")
      .attr("width", MAX_WIDTH)
      .attr("height", HEIGHT * data.length)

  current = chart;
  
  var scaleX = d3.scale.linear()
      .domain([0, max_time])
      .range([0, MAX_WIDTH]);

  var ticks = scaleX.ticks(20);

    chart.selectAll("line")
      .data(ticks)
      .enter().append("line")
      .attr("x1", scaleX)
      .attr("x2", scaleX)
      .attr("y1", 0)
      .attr("y2", HEIGHT * data.length)
      .style("stroke", "#ccc");

    chart.selectAll(".rule")
      .data(ticks)
      .enter().append("text")
      .attr("class", "rule")
      .attr("x", scaleX)
      .attr("y", 0)
      .attr("dy", -3)
      .attr("text-anchor", "middle")
      .text(String);

    chart.selectAll("line.bottom")
      .data(ticks)
      .enter().append("line")
      .attr("x1", scaleX)
      .attr("x2", scaleX)
      .attr("y1", 0)
      .attr("y2", HEIGHT * data.length)
      .attr("class", "bottom")
      .style("stroke", "#eee");

    chart.selectAll(".rule-bottom")
      .data(ticks)
      .enter().append("text")
      .attr("class", "rule-bottom")
      .attr("x", scaleX)
      .attr("y", 0)
      .attr("dy", (HEIGHT * data.length) + 10)
      .attr("text-anchor", "middle")
      .text(String);

    chart.append("line")
      .attr("y1", 0)
      .attr("y2", HEIGHT * data.length)
      .style("stroke", "#000");

  var tip = d3.svg.tip();
  var rows = chart.selectAll("g")
      .data(data)
      .enter().append("g")
      .attr("transform", function(d, i) { return "translate(0, " + i * HEIGHT + ")"; })
      .on('mouseover', function(d, i) {
        d3.select(this).attr('class', 'selected');
        tip.call(d3.select('rect.total').node(), d, i);
        tip.offset(function(d, i) {
          return [scaleX(min(d)), (i * HEIGHT) + 5]
        }).padding(8).orient('right').text(function(d) {
          return d.node.id + ' | Self: '  + formatTime(addTime(d)) + ' | Total: ' + formatTime(delta(d));
        }).attr('class', 'd3-tip');
      })
      .on('mouseout',  function() {
        d3.select(this).attr('class', '')
      });

    rows.append("rect")
      .attr("y", 0)
      .attr("x", 0)
      .attr("width", MAX_WIDTH)
      .attr("height", INNER_HEIGHT)
      .attr("class", "bckgrnd");

    rows.append("rect")
      .attr("y", 0)
      .attr("x", function(d, i) { return scaleX(min(d)); })
      .attr("width", function(d) { return scaleX(delta(d)); })
      .attr("height", INNER_HEIGHT)
      .attr("class", "total");

    rows.selectAll("rect.actual")
      .data(function(d) { return d })
      .enter().append("rect")
      .attr("y", 0)
      .attr("x", function(d, i) { return scaleX(d[0]); })
      .attr("width", function(d) { return scaleX(d[1] - d[0]); })
      .attr("height", INNER_HEIGHT)
      .attr("class", "actual");
}

</script>

</body>
</html>
